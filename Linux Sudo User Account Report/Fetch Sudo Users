#!/bin/bash

###############################################################################
# Script Name: Fetch_Sudo_Users.sh
# Description: Generates a CSV-style report listing all users with sudo access
#              on the current Linux host. Useful for access audits and compliance.
# Author: Chakravarthi Pulikonda
# Date: August 2025
###############################################################################

#-----------------------------#
# Environment Initialization #
#-----------------------------#

# Get system hostname
hostname=$(hostname)

# Get primary IP address (first one listed)
ip=$(hostname -I | awk '{print $1}')

#-----------------------------#
# SUDO User Extraction Logic #
#-----------------------------#

# Extract sudo users from /etc/sudoers:
# - Exclude comments (#), group entries (%), and empty lines
# - Match lines containing 'ALL' (typical sudo permission pattern)
# - Extract the first field (username)
# - Remove duplicates and format as comma-separated list

users=$(sudo grep -vE '^#|^%|^$' /etc/sudoers | awk '/ALL/ {print $1}' | sort -u | paste -sd "," - | sed 's/,/, /g')

#-----------------------------#
# Output Formatting & Report #
#-----------------------------#

# Output CSV header
#echo "Hostname,IP Address,Sudo Users"


if [[ -n "$users" ]]; then
    # If sudo users are found, print them Output format: hostname,IP address,"user1, user2, user3"
    echo "$hostname,$ip,\"$users\""
else
    # If no sudo users found, print a placeholder message
    echo "$hostname,$ip,\"No sudo users found or insufficient privileges\""


fi

###############################################################################
# Notes:
# - This script assumes sudo permissions to read /etc/sudoers.
# - It does not parse included files (e.g., /etc/sudoers.d/*).
# - Can be extended to include group-based sudo access if needed.
# - Useful for periodic audits or integration into iWorkflow automation.
###############################################################################
